<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星際交易所 - 主控台</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 頁面特定樣式 (Page-Specific Styles) */
        /* 用於個人資料頁的「檢視模式」與「編輯模式」切換邏輯 */
        .edit-mode { display: none; } /* 預設隱藏編輯輸入框 */
        .editing .edit-mode { display: block; } /* 當父層有 .editing 時顯示 */
        .editing .view-mode { display: none; } /* 當父層有 .editing 時隱藏純文字 */
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

    <div class="stars"></div>

    <div class="container" id="loginPanel">
        <h1>指揮中心</h1>
        <div class="form-group">
            <label>呼號 (帳號)</label>
            <input type="text" id="loginAccount" placeholder="請輸入您的 ID">
        </div>
        <div class="form-group">
            <label>通行碼 (密碼)</label>
            <input type="password" id="loginPassword" placeholder="請輸入您的密碼">
        </div>
        <button class="btn" onclick="login()">啟動連結</button>
        <div class="toggle-text">
            沒有權限? <span onclick="showRegister()">申請加入</span>
        </div>
        <div id="loginMsg"></div>
    </div>

    <div class="container hidden" id="registerPanel">
        <h2>新進學員</h2>
        <div class="form-group">
            <label>帳號</label>
            <input type="text" id="regAccount">
        </div>
        <div class="form-group">
            <label>密碼</label>
            <input type="password" id="regPassword">
        </div>
        <div class="form-group">
            <label>姓名</label>
            <input type="text" id="regName">
        </div>
        <div class="form-group">
            <label>通訊號碼 (電話)</label>
            <input type="text" id="regNumber">
        </div>
        <button class="btn" onclick="register()">提交資料</button>
        <div class="toggle-text">
            已有 ID? <span onclick="showLogin()">返回登入</span>
        </div>
        <div id="regMsg"></div>
    </div>

    <div class="container hidden" id="dashboardPanel">
        <h2>艦橋主控台</h2>
        <p style="text-align: center; color: #aaa; margin-bottom: 30px;">
            歡迎歸隊，指揮官 <span id="dashName" style="color: var(--neon-blue);">---</span>
        </p>
        
        <div class="nav-grid">
            <div class="nav-item" onclick="showProfile()">
                <h3>會員資訊</h3>
                <p>管理個人檔案</p>
            </div>
            <div class="nav-item" onclick="showWallet()">
                <h3>我的錢包</h3>
                <p>資產與餘額</p>
            </div>
            <div class="nav-item" onclick="showSpot()">
                <h3>交易中心</h3>
                <p>Trading Center</p>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">終止連線 (登出)</button>
    </div>

    <div class="container hidden" id="profilePanel">
        <div class="header-row">
            <button class="btn-back" onclick="showDashboard()">← 返回</button>
            <h2>飛行員檔案</h2>
        </div>
        
        <div id="profileContent" class="profile-info"> 
            
            <div class="profile-row">
                <span class="profile-label">帳號</span>
                <span id="displayAccount">---</span>
            </div>

            <div class="form-group">
                <label>姓名</label>
                <div class="view-mode" id="viewName">---</div>
                <input type="text" class="edit-mode" id="updateName">
            </div>

            <div class="form-group">
                <label>通訊號碼 (電話)</label>
                <div class="view-mode" id="viewNumber">---</div>
                <input type="text" class="edit-mode" id="updateNumber">
            </div>

            <div class="form-group edit-mode"> 
                <label>新密碼 (選填)</label>
                <input type="password" id="updatePassword" placeholder="留空則不修改">
            </div>

        </div>

        <div style="margin-top: 20px;">
            <button id="btnEdit" class="btn view-mode" onclick="enableEditMode()">修改資料</button>
            
            <div id="actionBtns" class="btn-group edit-mode">
                <button class="btn" onclick="updateProfile()">保存變更</button>
                <button class="btn btn-secondary" onclick="disableEditMode()">取消</button>
            </div>
        </div>

        <div id="profileMsg"></div>
    </div>

    <div class="container hidden" id="walletPanel">
        <div class="header-row">
            <button class="btn-back" onclick="showDashboard()">← 返回</button>
            <h2>我的錢包</h2>
            <button class="btn btn-sm" style="width: auto; background: linear-gradient(90deg, #ff4d4d, #bc13fe); margin: 0;" onclick="resetWallets()">一鍵重置</button>
        </div>
        
        <div class="wallet-controls" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
            <div class="control-group">
                <label style="margin-right: 5px;">排序:</label>
                <select id="walletSortBy" onchange="renderWallets()" style="padding: 5px; border-radius: 4px; border: 1px solid #555; background: #222; color: white;">
                    <option value="NAME">幣種名稱</option>
                    <option value="BALANCE">持有數量</option>
                    <option value="VALUE">USDT 價值</option>
                </select>
                <select id="walletSortOrder" onchange="renderWallets()" style="padding: 5px; border-radius: 4px; border: 1px solid #555; background: #222; color: white;">
                    <option value="ASC">由低到高</option>
                    <option value="DESC">由高到低</option>
                </select>
            </div>
            <div class="control-group" style="display: flex; align-items: center;">
                <input type="checkbox" id="walletHideZero" onchange="renderWallets()" style="margin-right: 5px;">
                <label for="walletHideZero" style="cursor: pointer;">隱藏 0 餘額</label>
            </div>
        </div>

        <div id="walletList" class="wallet-grid"></div>

        <div id="depositModal" class="modal-overlay hidden">
            <div class="modal-content">
                <span class="modal-close" onclick="closeDepositModal()">&times;</span>
                <h3>資產儲值</h3>
                <p style="text-align: center; color: var(--neon-blue);" id="depositCoinName">USDT</p>
                <div class="form-group">
                    <label>金額</label>
                    <input type="number" id="depositAmount" placeholder="輸入數量">
                </div>
                <button class="btn" onclick="submitDeposit()">確認儲值</button>
            </div>
        </div>
    </div>

    <div class="container hidden" id="tradePanel" style="width: 1100px; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
        
        <div style="width: 100%; margin-bottom: 10px;">
            <div class="btn-group" id="chartTimeframeGroup">
                <button class="btn btn-sm" onclick="setChartInterval('1m')">1m</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('5m')">5m</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('15m')">15m</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('30m')">30m</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('1h')">1h</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('4h')">4h</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('1d')">1d</button>
                <button class="btn btn-sm btn-secondary" onclick="setChartInterval('1w')">1w</button>
                <button class="btn btn-sm" onclick="resetChartZoom()" style="margin-left: 10px; background: rgba(255,255,255,0.1); border: 1px solid #777;">
                    ⟲ 重置視野
                </button>
            </div>
        </div>
        <div id="chartContainer" style="width: 100%; height: 400px; background: rgba(0,0,0,0.2); margin-bottom: 20px; border-radius: 12px; position: relative;"></div>

        <div style="display:flex; gap:20px; width:100%;">
            
            <div style="flex: 1;">
                <div class="header-row">
                    <button class="btn-back" onclick="showDashboard()">← 返回</button>
                    <h2 id="tradePanelTitle">交易下單</h2>
                </div>
                
                <div class="form-group">
                    <label id="labelSymbol">交易對</label>
                    <div class="searchable-dropdown" style="position: relative;">
                        <input type="text" id="tradeSymbolSearch" placeholder="搜尋或選擇..." autocomplete="off" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px;">
                        <input type="hidden" id="tradeSymbol">
                        <div id="tradeSymbolList" class="dropdown-list hidden">
                            </div>
                    </div>
                </div>

                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn" id="btnBuy" onclick="setOrderSide('BUY')" style="background: var(--neon-blue); color: black;">買入 (BUY)</button>
                    <button class="btn btn-secondary" id="btnSell" onclick="setOrderSide('SELL')">賣出 (SELL)</button>
                </div>

                <div class="form-group">
                    <label>訂單類型</label>
                    <select id="tradeType" onchange="togglePriceInput()" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px;">
                        <option value="LIMIT">限價單 (Limit)</option>
                        <option value="MARKET">市價單 (Market)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>價格 (Price)</label>
                    <input type="number" id="tradePrice" placeholder="輸入價格">
                </div>

                <div class="form-group">
                    <label>數量 (Quantity)</label>
                    <input type="number" id="tradeQuantity" placeholder="輸入數量">
                </div>

                <button class="btn" onclick="submitOrder()">下單</button>
            </div>

            <div style="flex: 1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; height: 100%; min-height: 400px;">
                <div style="text-align: center; margin-bottom: 10px; font-weight: bold;">訂單牆</div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em;">
                    <div style="text-align: center;">
                        <div style="color: #aaa;">市價賣出 (Bid)</div>
                        <div id="bestBidPrice" style="color: #00f3ff; font-weight: bold; font-size: 1.1em;">---</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #aaa;">市價買入 (Ask)</div>
                        <div id="bestAskPrice" style="color: #ff4d4d; font-weight: bold; font-size: 1.1em;">---</div>
                    </div>
                </div>

                <div id="orderBookAsks" style="display: flex; flex-direction: column-reverse; gap: 2px; min-height: 150px; justify-content: flex-end;"></div>

                <div style="margin: 10px 0; border-top: 1px dashed #555;"></div>

                <div id="orderBookBids" style="display: flex; flex-direction: column; gap: 2px;"></div>
            </div>

            <div style="flex: 1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; height: 100%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; font-size: 1.1em;">我的委託</h3>
                    <button class="btn btn-sm" onclick="fetchMyOrders()" style="width: auto;">↻</button>
                </div>
                
                <div class="btn-group" style="margin-bottom: 15px; gap: 5px;">
                    <button class="btn btn-sm" id="filterALL" onclick="setOrderFilter('ALL')" style="font-size: 0.8em; flex: 1; background: var(--neon-blue); color: black; border: 1px solid var(--neon-blue);">全部</button>
                    <button class="btn btn-sm" id="filterOPEN" onclick="setOrderFilter('OPEN')" style="font-size: 0.8em; flex: 1; background: transparent; border: 1px solid #555;">未成交</button>
                    <button class="btn btn-sm" id="filterFILLED" onclick="setOrderFilter('FILLED')" style="font-size: 0.8em; flex: 1; background: transparent; border: 1px solid #555;">已成交</button>
                    <button class="btn btn-sm" id="filterCANCELED" onclick="setOrderFilter('CANCELED')" style="font-size: 0.8em; flex: 1; background: transparent; border: 1px solid #555;">已取消</button>
                </div>

                <div id="orderList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <div id="positionSection" style="width: 100%; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1.1em; color: var(--neon-purple);">當前持倉 (Positions)</h3>
                <button class="btn btn-sm" onclick="fetchPositions()" style="width: auto;">↻</button>
            </div>
            <div id="positionList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="historySection" style="width: 100%; margin-top: 20px;">
             <h3 style="text-align: left; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px;">歷史紀錄</h3>
             <div class="btn-group" style="margin-bottom: 15px;">
                 <button class="btn btn-sm" id="tabHistoryFunds" onclick="switchHistoryTab('FUNDS')" style="background: var(--neon-blue); color: black;">資金流水</button>
                 <button class="btn btn-sm" id="tabHistoryTrades" onclick="switchHistoryTab('TRADES')">成交紀錄</button>
            </div>
            <div id="historyContent" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; min-height: 200px; max-height: 400px; overflow-y: auto;">
                 </div>
        </div>

    </div>

    <script src="script.js?v=11"></script>
</body>
</html>